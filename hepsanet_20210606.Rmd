---
title: "HEPSANET analysis"
author: "Marc Henrion"
date: "6 June 2021"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(rjags)


knitr::opts_chunk$set(echo = TRUE)
```

## Purpose of this analysis

This report fits bivariate Bayesian model similar to those described in [Riley et al (2008)](https://doi.org/10.1002/sim.3441), [Reitsma et al (2005)](https://doi.org/10.1016/j.jclinepi.2005.02.022) and [Owen et al (2018)](https://doi.org/10.1016/j.jclinepi.2018.03.005) in order to get a meta-analysis estimate of the operational characteristics of diagnostic tests for liver fibrosis and cirrhosis based on different biomarkers.

Below we define 4 models, corresponding to those from [Riley et al (2008)](https://doi.org/10.1002/sim.3441). Each of those models would be fit several times: for each combination of reference diagnostic and experimental diagnostic.

## Reading the data extracted during the systematic review

```{r readData}
datFile<-"../2021-05-24_Data/HEPSANET_biomarker_cleaned_data.csv"
dat<-read.csv(datFile)

dat<-dat %>%
  mutate(ReasontotestHBVSCLF=gsub(pattern=" ",replacement="",case_when(ReasontotestHBVSCLF==""~"N",ReasontotestHBVSCLF=="I"~"L",TRUE~ReasontotestHBVSCLF))) %>%
  mutate(
    testReason=factor(ReasontotestHBVSCLF,levels=c("C","S","L","F","N")),
    studyType=factor(hosp_com)
    )

setOfDummyVars<-model.matrix(~studyType+testReason,data=dat)
dat<-cbind(dat,setOfDummyVars[,-1])
```

The file `r datFile` contains `r nrow(dat)` rows / observations and `r ncol(dat)` columns / variables.

Notes:

* 2 samples (`SN030`, `SN021`) has reason for testing listed as `I`, I have replaced these with `L`, which seemed the most obvious mispelling. Please confirm this is appropriate.

* Only 2 samples (`H014`, `H009`) were the reason for testing is `F`. Merge these with test reason `L`?

```{r summaryData}
sumFun<-function(dat,vars,type,digs=2,na.rm=TRUE){
  # dat = data frame to be summarised
  # vars = character vector with variables names
  # type = character vector of same length as vars specifying the type of summary to compute (needs to be one of "mean_sd","median_iqr","n_perc")
  # digs = integer specifying the number of decimal digits to report (defaults to 2)
  # na.rm = whether to remove NAs or not (defaults to TRUE)
  
  res<-data.frame(
    var=character(0),
    stat1=character(0),
    stat2=character(0)
  )
  
  for(i in 1:length(vars)){
    if(type[i]=="mean_sd"){
      stat1<-format(nsmall=digs,round(digits=digs,mean(dat[,vars[i]],na.rm=T)))
      stat2<-paste(sep="","(",format(nsmall=digs,round(digits=digs,sd(dat[,vars[i]],na.rm=T))),")")
      #varName<-paste(sep=" ",vars[i],"; mean (sd)")
      varName<-paste(sep=" ","mean (sd)")
      
      res<-rbind(res,c(varName,stat1,stat2))
      rm(varName,stat1,stat2)
    }else if(type[i]=="median_iqr"){
      stat1<-format(nsmall=digs,round(digits=digs,median(dat[,vars[i]],na.rm=T)))
      stat2<-paste(sep="","(",paste(collapse=",",format(nsmall=digs,round(digits=digs,quantile(dat[,vars[i]],probs=c(0.25,0.75),na.rm=T)))),")")
      
      #varName<-paste(sep=" ",vars[i],"; median (IQR)")
      varName<-paste(sep=" ","median (IQR)")
      res<-rbind(res,c(varName,stat1,stat2))
      rm(varName,stat1,stat2)
    }else if(type[i]=="n_perc"){
      for(val in sort(unique(dat[,vars[i]]))){
        stat1<-sum(dat[,vars[i]]==val,na.rm=T)
        stat2<-paste(sep="","(",format(nsmall=digs,round(digits=digs,100*sum(dat[,vars[i]]==val,na.rm=T)/sum(!is.na(dat[,vars[i]])))),"%)")
        
        #varName<-paste(sep="",vars[i],"; ",val,"; n (%)")
        varName<-paste(sep="",val,"; n (%)")
        res<-rbind(res,c(varName,stat1,stat2))
        rm(varName,stat1,stat2)
      }
    }
  }
  
  colnames(res)<-c("variable","stat1","stat2")
  return(res)
}
  
datSum<-sumFun(dat,
               vars=c("hosp_com","site","sex","age","bmi","te","apri","gpr","fib4","alt"),
               type=c("n_perc","n_perc","n_perc","median_iqr","mean_sd","median_iqr","median_iqr","median_iqr","median_iqr","median_iqr","median_iqr"))

datSum %>%
  kable(caption="Patient characteristics",row.names=F) %>%
  kable_styling(full_width=F) %>%
  pack_rows(start_row=1,end_row=2,group_label=paste(sep="","Type of study; n = ",sum(!is.na(dat$hosp_com))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$hosp_com))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=3,end_row=13,group_label=paste(sep="","Site; n = ",sum(!is.na(dat$site))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$site))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=14,end_row=15,group_label=paste(sep="","Sex; n = ",sum(!is.na(dat$sex))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$age))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=16,end_row=16,group_label=paste(sep="","Age; n = ",sum(!is.na(dat$age))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$age))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=17,end_row=17,group_label=paste(sep="","BMI; n = ",sum(!is.na(dat$bmi))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$bmi))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=18,end_row=18,group_label=paste(sep="","Transient elastography; n = ",sum(!is.na(dat$te))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$te))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=19,end_row=19,group_label=paste(sep="","APRI (AST to platelet ratio); n = ",sum(!is.na(dat$apri))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$apr))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=20,end_row=20,group_label=paste(sep="","GPR (GGT to platelet ratio); n = ",sum(!is.na(dat$gpr))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$gpr))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=21,end_row=21,group_label=paste(sep="","Fibrosis 4 score; n = ",sum(!is.na(dat$bmi))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$bmi))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=22,end_row=22,group_label=paste(sep="","ALT; n = ",sum(!is.na(dat$bmi))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$bmi))/nrow(dat))),"%)"))
```


## Definiton of the gold standard diagnosis

Reference standards (which are assumed to be gold standards) are based on variable `te`, transient elastrography result. Specifically:

* Cirrhosis (F4) if $te>11.5kPa$ (sensitivity analysis $te>9.5kPa$)
* Significant fibrosis (F2) if $te>7.9kPa$

In the dataset, these 3 gold standards are encoded by variables `te_115`, `te_95` and `te_79`.

```{r defineVarsGold}
dat<-dat %>%
  mutate(
    te_115=ifelse(te>11.5,1,0),
    te_95=ifelse(te>9.5,1,0),
    te_79=ifelse(te>7.9,1,0),
  )
```

## Diagnostics to be evaluated

* `apri` - AST to platelet ratio index. For F4 use threshold of $\geq 2.0$ and for F2 use $\geq 1.5$. In the dataset, these 2 experimental diagnostics are encoded by variables `apri_20` and `apri_15`. Note: we will also derive an optimum threshold.

* `gpr` - GGT to platelet ratio. For F4 use threshold $\geq 0.56$ and for F2 use $\geq 0.32$. In the dataset, these 2 experimental diagnostics are encoded by variables `gpr_56` and `gpr_32`.

* `fib4` - fibrosis 4 score. We need to derive a score for this; no a prior defined threshold.

* `alt` - ALT. We need to derive a score for this; no a prior defined threshold.


```{r defineVarsEval}
dat<-dat %>%
  mutate(
    apri_20=ifelse(apri>=2,1,0),
    apri_15=ifelse(apri>=1.5,1,0),
    gpr_56=ifelse(gpr>=0.56,1,0),
    gpr_32=ifelse(gpr>=0.32,1,0),
  )
```

## Very naive analysis (to get feel for data)

Let's just assume we could analyse all individual-level data as is, simply pulling out the sensitivity, specificity rather than fitting a model that considers random effects and individual- and study-level covariates.

```{r naiveSensSpec}
gr<-rbind(
  c(11.5,"2.0","0.56"),
  c(9.5,"2.0","0.56"),
  c(7.9,"1.5","0.32")
)

rnames<-character(0)
for(s in c("All",sort(unique(dat$Sitecountry)))){
  for(i in 1:3){
    rnames<-c(rnames,paste(sep="_",paste(sep="","Site",s),paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))))
  }
}
rnames<-gsub(rnames,pattern="SiteAll",replacement="All")

sensSpecMat<-matrix(nrow=3*(length(unique(dat$Sitecountry))+1),ncol=8)
rownames(sensSpecMat)<-rnames
colnames(sensSpecMat)<-c("site","te","apri","gpr","apri_sens","apri_spec","gpr_sens","gpr_spec")
sensSpecMat<-as.data.frame(sensSpecMat)

for(s in c("All",sort(unique(dat$Sitecountry)))){
  if(s=="All"){
    datTmp<-dat
  }else{
    datTmp<-dat %>% filter(Sitecountry==s)
    s<-paste(sep="","Site",s)
  }
    
  for(i in 1:nrow(gr)){
    gthr<-gr[i,1]
    thr1<-gr[i,2]
    thr2<-gr[i,3]
    
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"site"]<-gsub(s,pattern="Site",replacement="")
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"te"]<-gthr
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"apri"]<-thr1
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"gpr"]<-thr2
    
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"apri_sens"]<-mean(datTmp[datTmp[,paste(sep="_","te",gsub(gthr,pattern="\\.",replacement=""))]==1,paste(sep="_","apri",gsub(thr1,pattern="\\.",replacement=""))])
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"gpr_sens"]<-mean(datTmp[datTmp[,paste(sep="_","te",gsub(gthr,pattern="\\.",replacement=""))]==1,paste(sep="_","gpr",gsub(thr2,pattern="0\\.",replacement=""))],na.rm=T)
    
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"apri_spec"]<-mean(1-datTmp[datTmp[,paste(sep="_","te",gsub(gthr,pattern="\\.",replacement=""))]==0,paste(sep="_","apri",gsub(thr1,pattern="\\.",replacement=""))])
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"gpr_spec"]<-mean(1-datTmp[datTmp[,paste(sep="_","te",gsub(gthr,pattern="\\.",replacement=""))]==0,paste(sep="_","gpr",gsub(thr2,pattern="0\\.",replacement=""))],na.rm=T)
    
  }
}

sensSpecMatKable<-sensSpecMat
for(i in 1:nrow(sensSpecMat)){
  for(j in 5:ncol(sensSpecMat)){
    if(!is.na(sensSpecMat[i,j])){
      sensSpecMatKable[i,j]<-paste(sep="",format(nsmall=1,round(digits=1,100*sensSpecMat[i,j])),"%")
    }else{
      sensSpecMatKable[i,j]<-"-"
    }
  }
}
rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te11.5_apri2.0_gpr0.56")]<-gsub(rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te11.5_apri2.0_gpr0.56")],pattern="_te11.5_apri2.0_gpr0.56",replacement="; te > 11.5 (apri > 2.0, gpr > 0.56)")
rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te9.5_apri2.0_gpr0.56")]<-gsub(rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te9.5_apri2.0_gpr0.56")],pattern="_te9.5_apri2.0_gpr0.56",replacement="; te > 9.5 (apri > 2.0, gpr > 0.56)")
rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te7.9_apri1.5_gpr0.32")]<-gsub(rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te7.9_apri1.5_gpr0.32")],pattern="_te7.9_apri1.5_gpr0.32",replacement="; te > 7.9 (apri > 1.5, gpr > 0.32)")

sensSpecMatKable <- cbind("",sensSpecMatKable)

sensSpecMatKable %>%
  dplyr::select(!site) %>%
  kable(caption="Naive sensitivity and specificity estimates (expressed as percentages).",col.names=c(" ","TE","APRI","GPR","Sensitivity","Specificity","Sensitivity","Specificity"),row.names = FALSE) %>%
  kable_styling(full_width = FALSE) %>%
  add_header_above(c(" "=1,"Diagnostic thresholds"=3,"APRI"=2,"GPR"=2)) %>%
  pack_rows(start_row=1,end_row=3,group_label="All samples") %>%
  pack_rows(start_row=4,end_row=6,group_label="Site 1") %>%
  pack_rows(start_row=7,end_row=9,group_label="Site 2") %>%
  pack_rows(start_row=10,end_row=12,group_label="Site 3") %>%
  pack_rows(start_row=13,end_row=15,group_label="Site 4") %>%
  pack_rows(start_row=16,end_row=18,group_label="Site 5") %>%
  pack_rows(start_row=19,end_row=21,group_label="Site 6") %>%
  pack_rows(start_row=22,end_row=24,group_label="Site 7") %>%
  pack_rows(start_row=25,end_row=27,group_label="Site 8") %>%
  pack_rows(start_row=28,end_row=30,group_label="Site 9") %>%
  pack_rows(start_row=31,end_row=33,group_label="Site 10") %>%
  pack_rows(start_row=34,end_row=36,group_label="Site 11")
```

## Null model (same sensitivity / specificity per site)

This model directly estimates a single sensitivity and specificity.

```{r model0, warning=F, message=F}
datJags<-list()

datJags$N<-nrow(dat)
datJags$state<-ifelse(dat$te_115==1,1,2)
datJags$y<-dat$apri_20
  
randSeed<-20210521
set.seed(randSeed)

jagsModel0_te115_apri20 <- jags.model('jagsModel0_NullNoHet_20210606.jags', data=datJags, n.chains = 4, n.adapt = 1000)
parsModel0_te115_apri20<-coda.samples(model=jagsModel0_te115_apri20,variable.names=c('p_sens','p_spec'),n.iter=5000)
dicModel0_te115_apri20<-dic.samples(jagsModel0_te115_apri20,type="pD",n.iter=1000)

print(summary(parsModel0_te115_apri20))
print(gelman.diag(parsModel0_te115_apri20))
```

## Null model (different sensitivity / specificty per site)

This model directly estimates a single sensitivity and specificity per site.

```{r model0, warning=F, message=F}
datJags<-list()

datJags$N<-nrow(dat)
datJags$m<-max(as.integer(factor(dat$Sitecountry,levels=as.character(1:11))))
datJags$study<-as.integer(factor(dat$Sitecountry,levels=as.character(1:11)))
datJags$state<-ifelse(dat$te_115==1,1,2)
datJags$y<-dat$apri_20
  
randSeed<-20210521
set.seed(randSeed)

jagsModel0_te115_apri20 <- jags.model('jagsModel0_NullWithHet_20210606.jags', data=datJags, n.chains = 4, n.adapt = 1000)
parsModel0_te115_apri20<-coda.samples(model=jagsModel0_te115_apri20,variable.names=c('p_sens','p_spec'),n.iter=5000)
dicModel0_te115_apri20<-dic.samples(jagsModel0_te115_apri20,type="pD",n.iter=1000)

print(summary(parsModel0_te115_apri20))
print(gelman.diag(parsModel0_te115_apri20))
```

## Model 1

This model estimates summary sensitivity and specificity with study random effects only, and does not take either individual or study covariates into account.

```{r model1, warning=F, message=F}
datJags<-list()

datJags$N<-nrow(dat)
datJags$m<-max(as.integer(factor(dat$Sitecountry)))
datJags$study<-as.integer(factor(dat$Sitecountry))
datJags$state<-ifelse(dat$te_115==1,1,2)
datJags$y<-dat$apri_20
  
randSeed<-20210521
set.seed(randSeed)

jagsModel1_te115_apri20 <- jags.model('jagsModel1_NoIndivRandomNoCovariates_20210524.jags', data=datJags, n.chains = 4, n.adapt = 1000)
parsModel1_te115_apri20<-coda.samples(model=jagsModel1_te115_apri20,variable.names=c('beta','p_sens','p_spec'),n.iter=5000)
dicModel1_te115_apri20<-dic.samples(jagsModel1_te115_apri20,type="pD",n.iter=1000)

print(summary(parsModel1_te115_apri20))
print(gelman.diag(parsModel1_te115_apri20))
```
}

## Model 2

This model estimates sensitivity and specificity with study and individual random effects, and does not take either individual or study covariates into account.

```{r model2, warning=F, message=F}
datJags<-list()

datJags$N<-nrow(dat)
datJags$m<-max(as.integer(factor(dat$Sitecountry)))
datJags$study<-as.integer(factor(dat$Sitecountry))
datJags$state<-ifelse(dat$te_115==1,1,2)
datJags$y<-dat$apri_20
  
randSeed<-20210521
set.seed(randSeed)

jagsModel2_te115_apri20 <- jags.model('jagsModel2_IndivRandomNoCovariates_20210524.jags', data=datJags, n.chains = 4, n.adapt = 1000)
parsModel2_te115_apri20<-coda.samples(model=jagsModel2_te115_apri20,variable.names=c('beta'),n.iter=5000)
dicModel2_te115_apri20<-dic.samples(jagsModel2_te115_apri20,type="pD",n.iter=1000) # complains about there being no stochastic nodes which is nonsense; somewhat worrying though

print(summary(parsModel2_te115_apri20))
print(gelman.diag(parsModel2_te115_apri20))
```

## Model 3

This model estimates summary sensitivity and specificity with study random effects and individual-level covariates.

We skipped this model to focus directly on model 4.


## Model 4

This model estimates summary sensitivity and specificity with study random effects and individual- and study-level covariates.

```{r model4, warning=F, message=F}
datJags<-list()

datJags$N<-nrow(dat)
datJags$m<-max(as.integer(factor(dat$Sitecountry)))
datJags$study<-as.integer(factor(dat$Sitecountry))
datJags$state<-ifelse(dat$te_115==1,1,2)
datJags$y<-dat$apri_20
datJags$studyTypeHospital<-dat$studyTypeHospital
datJags$testReasonS<-dat$testReasonS
datJags$testReasonL<-dat$testReasonL
datJags$testReasonF<-dat$testReasonF
datJags$testReasonN<-dat$testReasonN
datJags$testReasonSMean<-numeric(length(unique(datJags$study)))
datJags$testReasonLMean<-numeric(length(unique(datJags$study)))
datJags$testReasonFMean<-numeric(length(unique(datJags$study)))
datJags$testReasonNMean<-numeric(length(unique(datJags$study)))
for(i in unique(as.integer(factor(dat$Sitecountry)))){
  datJags$testReasonSMean[i]<-mean(datJags$testReasonS[datJags$study==i])
  datJags$testReasonLMean[i]<-mean(datJags$testReasonL[datJags$study==i])
  datJags$testReasonFMean[i]<-mean(datJags$testReasonF[datJags$study==i])
  datJags$testReasonNMean[i]<-mean(datJags$testReasonN[datJags$study==i])
}


randSeed<-20210606
set.seed(randSeed)

jagsModel4_te115_apri20 <- jags.model('jagsModel4_IndivAndStudyCovariates_20210606.jags', data=datJags, n.chains = 4, n.adapt = 5000)
parsModel4_te115_apri20<-coda.samples(model=jagsModel4_te115_apri20,variable.names=c('beta','gamma1W','gamma1B','gamma2W','gamma2B','gamma3W','gamma3B','gamma4W','gamma4B','lambda'),n.iter=5000)
dicModel4_te115_apri20<-dic.samples(jagsModel4_te115_apri20,type="pD",n.iter=1000) 

print(summary(parsModel4_te115_apri20))
print(gelman.diag(parsModel4_te115_apri20))
```
