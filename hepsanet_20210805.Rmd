---
title: "HEPSANET analysis"
author: "Marc Henrion"
date: "05 August 2021"
output:
  bookdown::html_document2:
    code_folding: hide
    number_sections: false
---

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(rjags)
library(HDInterval)
library(scam)
library(MCMCvis)
library(parallel)
library(doParallel)
library(foreach)

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE, message = FALSE)

outDir<-paste(sep="","../output/",gsub(pattern="-",replacement="",Sys.Date()))
if(!dir.exists(outDir)){dir.create(outDir,recursive=TRUE)}
```

## Purpose of this analysis

This report fits bivariate Bayesian model similar to those described in [Riley et al (2008)](https://doi.org/10.1002/sim.3441), [Reitsma et al (2005)](https://doi.org/10.1016/j.jclinepi.2005.02.022) and [Owen et al (2018)](https://doi.org/10.1016/j.jclinepi.2018.03.005) in order to get a meta-analysis estimate of the operational characteristics of diagnostic tests for liver fibrosis and cirrhosis based on different biomarkers.

Below we define 4 models, corresponding to those from [Riley et al (2008)](https://doi.org/10.1002/sim.3441). Each of those models would be fit several times: for each combination of reference diagnostic and experimental diagnostic.

## Reading the data extracted during the systematic review

```{r readData}
datFile<-"../2021-06-24_RevisedData/HEPSANET_biomarker_cleaned_data.csv"
dat<-read.csv(datFile)

dat<-dat %>%
  mutate(ReasontotestHBVSCLF=gsub(pattern=" ",replacement="",case_when(ReasontotestHBVSCLF==""~"N",ReasontotestHBVSCLF=="I"~"L",TRUE~ReasontotestHBVSCLF))) %>%
  mutate(
    testReason=factor(ReasontotestHBVSCLF,levels=c("C","S","L","F","N")),
    studyType=factor(hosp_com)
    )

setOfDummyVars<-model.matrix(~studyType+testReason,data=dat)
dat<-cbind(dat,setOfDummyVars[,-1])
```

The file `r datFile` contains `r nrow(dat)` rows / observations and `r ncol(dat)` columns / variables.

Notes (as per Alex's email from 24 June 2021):

* 2 samples (`SN030`, `SN021`) has reason for testing listed as `I`, These have been replaced these with `L`.

* Only 2 samples (`H014`, `H009`) were the reason for testing is `F`. These have been merged with `S`?

```{r dataRecoding}
dat$testReason[dat$Nomerged %in% c("H014","H009")]<-"S"

dat<-dat %>%
  mutate(testReason=factor(as.character(testReason),levels=c("C","S","L","N")))
```

## Filtering out participants

We filter out participants who are positive for hepatitis C and/or D infection using the variables `antihcv`, `hcvrna`, and `antihdv` (all participants positive for any of these are filtered out). Participants with no records for these variables are retained.

```{r hepFilter}
nBefore<-nrow(dat)

dat<-dat %>%
  filter((is.na(antihcv) | antihcv!=1) &
           (is.na(hcvrna) | hcvrna!=1) &
           (is.na(antihdv) |antihdv!=1))
```

This has filtered out `r nBefore-nrow(dat)` participants, leaving `r `nrow(dat)` participants for the analysis.


```{r summaryData}
sumFun<-function(dat,vars,type,digs=2,na.rm=TRUE){
  # dat = data frame to be summarised
  # vars = character vector with variables names
  # type = character vector of same length as vars specifying the type of summary to compute (needs to be one of "mean_sd","median_iqr","n_perc")
  # digs = integer specifying the number of decimal digits to report (defaults to 2)
  # na.rm = whether to remove NAs or not (defaults to TRUE)
  
  res<-data.frame(
    var=character(0),
    stat1=character(0),
    stat2=character(0)
  )
  
  for(i in 1:length(vars)){
    if(type[i]=="mean_sd"){
      stat1<-format(nsmall=digs,round(digits=digs,mean(dat[,vars[i]],na.rm=T)))
      stat2<-paste(sep="","(",format(nsmall=digs,round(digits=digs,sd(dat[,vars[i]],na.rm=T))),")")
      #varName<-paste(sep=" ",vars[i],"; mean (sd)")
      varName<-paste(sep=" ","mean (sd)")
      
      res<-rbind(res,c(varName,stat1,stat2))
      rm(varName,stat1,stat2)
    }else if(type[i]=="median_iqr"){
      stat1<-format(nsmall=digs,round(digits=digs,median(dat[,vars[i]],na.rm=T)))
      stat2<-paste(sep="","(",paste(collapse=",",format(nsmall=digs,round(digits=digs,quantile(dat[,vars[i]],probs=c(0.25,0.75),na.rm=T)))),")")
      
      #varName<-paste(sep=" ",vars[i],"; median (IQR)")
      varName<-paste(sep=" ","median (IQR)")
      res<-rbind(res,c(varName,stat1,stat2))
      rm(varName,stat1,stat2)
    }else if(type[i]=="n_perc"){
      for(val in sort(unique(dat[,vars[i]]))){
        stat1<-sum(dat[,vars[i]]==val,na.rm=T)
        stat2<-paste(sep="","(",format(nsmall=digs,round(digits=digs,100*sum(dat[,vars[i]]==val,na.rm=T)/sum(!is.na(dat[,vars[i]])))),"%)")
        
        #varName<-paste(sep="",vars[i],"; ",val,"; n (%)")
        varName<-paste(sep="",val,"; n (%)")
        res<-rbind(res,c(varName,stat1,stat2))
        rm(varName,stat1,stat2)
      }
    }
  }
  
  colnames(res)<-c("variable","stat1","stat2")
  return(res)
}
  
datSum<-sumFun(dat,
               vars=c("hosp_com","site","sex","age","bmi","te","apri","gpr","fib4","alt"),
               type=c("n_perc","n_perc","n_perc","median_iqr","mean_sd","median_iqr","median_iqr","median_iqr","median_iqr","median_iqr","median_iqr"))

datSum %>%
  kable(caption="Patient characteristics",row.names=F) %>%
  kable_styling(full_width=F) %>%
  pack_rows(start_row=1,end_row=2,group_label=paste(sep="","Type of study; n = ",sum(!is.na(dat$hosp_com))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$hosp_com))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=3,end_row=13,group_label=paste(sep="","Site; n = ",sum(!is.na(dat$site))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$site))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=14,end_row=15,group_label=paste(sep="","Sex; n = ",sum(!is.na(dat$sex))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$age))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=16,end_row=16,group_label=paste(sep="","Age; n = ",sum(!is.na(dat$age))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$age))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=17,end_row=17,group_label=paste(sep="","BMI; n = ",sum(!is.na(dat$bmi))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$bmi))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=18,end_row=18,group_label=paste(sep="","Transient elastography; n = ",sum(!is.na(dat$te))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$te))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=19,end_row=19,group_label=paste(sep="","APRI (AST to platelet ratio); n = ",sum(!is.na(dat$apri))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$apri))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=20,end_row=20,group_label=paste(sep="","GPR (GGT to platelet ratio); n = ",sum(!is.na(dat$gpr))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$gpr))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=21,end_row=21,group_label=paste(sep="","Fibrosis 4 score; n = ",sum(!is.na(dat$bmi))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$bmi))/nrow(dat))),"%)")) %>%
  pack_rows(start_row=22,end_row=22,group_label=paste(sep="","ALT; n = ",sum(!is.na(dat$bmi))," (",format(nsmall=1,round(digits=1,100*sum(!is.na(dat$bmi))/nrow(dat))),"%)"))
```


## Definiton of the gold standard diagnosis

Reference standards (which are assumed to be gold standards) are based on variable `te`, transient elastrography result. Specifically:

* Cirrhosis (F4) if $te>11.5kPa$ (sensitivity analysis $te>9.5kPa$)
* Significant fibrosis (F2) if $te>7.9kPa$

In the dataset, these 3 gold standards are encoded by variables `te_115`, `te_95` and `te_79`.

```{r defineVarsGold}
dat<-dat %>%
  mutate(
    te_115=ifelse(te>11.5,1,0),
    te_95=ifelse(te>9.5,1,0),
    te_79=ifelse(te>7.9,1,0),
  )
```

## Diagnostics to be evaluated

* `apri` - AST to platelet ratio index. For F4 use threshold of $\geq 2.0$ and for F2 use $\geq 1.5$. In the dataset, these 2 experimental diagnostics are encoded by variables `apri_20` and `apri_15`. Note: we will also derive an optimum threshold.

* `gpr` - GGT to platelet ratio. For F4 use threshold $\geq 0.56$ and for F2 use $\geq 0.32$. In the dataset, these 2 experimental diagnostics are encoded by variables `gpr_56` and `gpr_32`.

* `fib4` - fibrosis 4 score. We need to derive a score for this; no a prior defined threshold.

* `alt` - ALT. We need to derive a score for this; no a prior defined threshold.


```{r defineVarsEval}
dat<-dat %>%
  mutate(
    apri_20=ifelse(apri>=2,1,0),
    apri_15=ifelse(apri>=1.5,1,0),
    gpr_56=ifelse(gpr>=0.56,1,0),
    gpr_32=ifelse(gpr>=0.32,1,0),
  )
```

## Very naive analysis (to get feel for data)

Let's just assume we could analyse all individual-level data as is, simply pulling out the sensitivity, specificity rather than fitting a model that considers random effects and individual- and study-level covariates.

```{r naiveSensSpec}
gr<-rbind(
  c(11.5,"2.0","0.56"),
  c(9.5,"2.0","0.56"),
  c(7.9,"1.5","0.32")
)

rnames<-character(0)
for(s in c("All",sort(unique(dat$Sitecountry)))){
  for(i in 1:3){
    rnames<-c(rnames,paste(sep="_",paste(sep="","Site",s),paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))))
  }
}
rnames<-gsub(rnames,pattern="SiteAll",replacement="All")

sensSpecMat<-matrix(nrow=3*(length(unique(dat$Sitecountry))+1),ncol=8)
rownames(sensSpecMat)<-rnames
colnames(sensSpecMat)<-c("site","te","apri","gpr","apri_sens","apri_spec","gpr_sens","gpr_spec")
sensSpecMat<-as.data.frame(sensSpecMat)

for(s in c("All",sort(unique(dat$Sitecountry)))){
  if(s=="All"){
    datTmp<-dat
  }else{
    datTmp<-dat %>% filter(Sitecountry==s)
    s<-paste(sep="","Site",s)
  }
    
  for(i in 1:nrow(gr)){
    gthr<-gr[i,1]
    thr1<-gr[i,2]
    thr2<-gr[i,3]
    
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"site"]<-gsub(s,pattern="Site",replacement="")
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"te"]<-gthr
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"apri"]<-thr1
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"gpr"]<-thr2
    
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"apri_sens"]<-mean(datTmp[datTmp[,paste(sep="_","te",gsub(gthr,pattern="\\.",replacement=""))]==1,paste(sep="_","apri",gsub(thr1,pattern="\\.",replacement=""))])
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"gpr_sens"]<-mean(datTmp[datTmp[,paste(sep="_","te",gsub(gthr,pattern="\\.",replacement=""))]==1,paste(sep="_","gpr",gsub(thr2,pattern="0\\.",replacement=""))],na.rm=T)
    
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"apri_spec"]<-mean(1-datTmp[datTmp[,paste(sep="_","te",gsub(gthr,pattern="\\.",replacement=""))]==0,paste(sep="_","apri",gsub(thr1,pattern="\\.",replacement=""))])
    sensSpecMat[paste(sep="_",s,paste(collapse="_",paste(sep="",c("te","apri","gpr"),gr[i,]))),"gpr_spec"]<-mean(1-datTmp[datTmp[,paste(sep="_","te",gsub(gthr,pattern="\\.",replacement=""))]==0,paste(sep="_","gpr",gsub(thr2,pattern="0\\.",replacement=""))],na.rm=T)
    
  }
}

sensSpecMatKable<-sensSpecMat
for(i in 1:nrow(sensSpecMat)){
  for(j in 5:ncol(sensSpecMat)){
    if(!is.na(sensSpecMat[i,j])){
      sensSpecMatKable[i,j]<-paste(sep="",format(nsmall=1,round(digits=1,100*sensSpecMat[i,j])),"%")
    }else{
      sensSpecMatKable[i,j]<-"-"
    }
  }
}
rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te11.5_apri2.0_gpr0.56")]<-gsub(rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te11.5_apri2.0_gpr0.56")],pattern="_te11.5_apri2.0_gpr0.56",replacement="; te > 11.5 (apri > 2.0, gpr > 0.56)")
rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te9.5_apri2.0_gpr0.56")]<-gsub(rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te9.5_apri2.0_gpr0.56")],pattern="_te9.5_apri2.0_gpr0.56",replacement="; te > 9.5 (apri > 2.0, gpr > 0.56)")
rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te7.9_apri1.5_gpr0.32")]<-gsub(rownames(sensSpecMatKable)[grepl(rownames(sensSpecMatKable),pattern="_te7.9_apri1.5_gpr0.32")],pattern="_te7.9_apri1.5_gpr0.32",replacement="; te > 7.9 (apri > 1.5, gpr > 0.32)")

sensSpecMatKable <- cbind("",sensSpecMatKable)

sensSpecMatKable %>%
  dplyr::select(!site) %>%
  kable(caption="Naive sensitivity and specificity estimates (expressed as percentages).",col.names=c(" ","TE","APRI","GPR","Sensitivity","Specificity","Sensitivity","Specificity"),row.names = FALSE) %>%
  kable_styling(full_width = FALSE) %>%
  add_header_above(c(" "=1,"Diagnostic thresholds"=3,"APRI"=2,"GPR"=2)) %>%
  pack_rows(start_row=1,end_row=3,group_label="All samples") %>%
  pack_rows(start_row=4,end_row=6,group_label="Site 1") %>%
  pack_rows(start_row=7,end_row=9,group_label="Site 2") %>%
  pack_rows(start_row=10,end_row=12,group_label="Site 3") %>%
  pack_rows(start_row=13,end_row=15,group_label="Site 4") %>%
  pack_rows(start_row=16,end_row=18,group_label="Site 5") %>%
  pack_rows(start_row=19,end_row=21,group_label="Site 6") %>%
  pack_rows(start_row=22,end_row=24,group_label="Site 7") %>%
  pack_rows(start_row=25,end_row=27,group_label="Site 8") %>%
  pack_rows(start_row=28,end_row=30,group_label="Site 9") %>%
  pack_rows(start_row=31,end_row=33,group_label="Site 10") %>%
  pack_rows(start_row=34,end_row=36,group_label="Site 11")
```


**Question:**

Sensitivity and specificity are extremely variable from study to study. I find it difficult to understand this. You would expect some heterogeneity due to how certain diagnostics are delivered, some underlying characteristics that impct test results which vary from population to population, but not quite to this extent. Positive and negative predictive values can vary a lot from one population to another, but that is because these, unlike sensitvity and specificity, depend on the prevalence of the condition under investigation.

Would be good to discuss this.


## Model

Earlier versions of this document (20210627 and earlier) compared several different models. From this, the decision was made for a model with individual- and study-level covariates and study-specific random effects

This is model (4) from [Riley et al (2008)](https://doi.org/10.1002/sim.3441).

This model estimates summary sensitivity and specificity with study random effects and individual- and study-level covariates.

We include the following co-variates:

* study type (community [default] or hospital based)
* reason for testing (community-based, routine or undocumented screening reason [default] or suspicion of liver disease)
* hazardous alcohol drinking (no [default] or yes)



## Pre-defined thresholds for APRI and GPR

As noted earlier in this document, there exist recommended thresholds for APRI (>2.0 for F4 and >1.5 for F2) and GPR (>0.56 for F4 and >0.32 for F2). Together with the 2 thresholds for the reference standard for F4 (te>11.5 and te>9.5) and 1 threshold for F2 (te>7.9), this gives 6 models for pre-defined models. The overall sensitivities and specificities for these models ar reported in Tables \@ref(tab:fixedThrSumApri) and \@ref(tab:fixedThrSumGpr) below. Model-specific tables giving ORs for the different co-variates are given in the appendix.


```{r model4NoBetweenStudyEffectsSimple_apri20_te115, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
datJags<-list()

datJags$N<-nrow(dat)
datJags$m<-max(as.integer(factor(dat$Sitecountry)))
datJags$study<-as.integer(factor(dat$Sitecountry))
datJags$state<-ifelse(dat$te_115==1,1,2)
datJags$y<-dat$apri_20
datJags$studyTypeHospital<-dat$studyTypeHospital
datJags$testReasonL<-dat$testReasonL
datJags$alc<-dat$alc

randSeed<-20210615
set.seed(randSeed)

jagsModel4_te115_apri20 <- jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
parsModel4_te115_apri20<-coda.samples(model=jagsModel4_te115_apri20,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)

tmp<-try(summary(parsModel4_te115_apri20)$statistics,silent=TRUE)
tmpCI<-t(hdi(parsModel4_te115_apri20))
mod_te115_apri20<-cbind(tmp,tmpCI)
rm(tmp,tmpCI)
```

```{r model4NoBetweenStudyEffectsSimple_apri20_te95, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
datJags<-list()

datJags$N<-nrow(dat)
datJags$m<-max(as.integer(factor(dat$Sitecountry)))
datJags$study<-as.integer(factor(dat$Sitecountry))
datJags$state<-ifelse(dat$te_95==1,1,2)
datJags$y<-dat$apri_20
datJags$studyTypeHospital<-dat$studyTypeHospital
datJags$testReasonL<-dat$testReasonL
datJags$alc<-dat$alc

randSeed<-20210615
set.seed(randSeed)

jagsModel4_te95_apri20 <- jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
parsModel4_te95_apri20<-coda.samples(model=jagsModel4_te95_apri20,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)

tmp<-try(summary(parsModel4_te95_apri20)$statistics,silent=TRUE)
tmpCI<-t(hdi(parsModel4_te95_apri20))
mod_te95_apri20<-cbind(tmp,tmpCI)
rm(tmp,tmpCI)
```

```{r model4NoBetweenStudyEffectsSimple_apri15_te79, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
datJags<-list()

datJags$N<-nrow(dat)
datJags$m<-max(as.integer(factor(dat$Sitecountry)))
datJags$study<-as.integer(factor(dat$Sitecountry))
datJags$state<-ifelse(dat$te_79==1,1,2)
datJags$y<-dat$apri_15
datJags$studyTypeHospital<-dat$studyTypeHospital
datJags$testReasonL<-dat$testReasonL
datJags$alc<-dat$alc

randSeed<-20210615
set.seed(randSeed)

jagsModel4_te79_apri15 <- jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
parsModel4_te79_apri15<-coda.samples(model=jagsModel4_te79_apri15,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)

tmp<-try(summary(parsModel4_te79_apri15)$statistics,silent=TRUE)
tmpCI<-t(hdi(parsModel4_te79_apri15))
mod_te79_apri15<-cbind(tmp,tmpCI)
rm(tmp,tmpCI)
```

```{r model4NoBetweenStudyEffectsSimple_gpr56_te115, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
datJags<-list()

datJags$N<-nrow(dat)
datJags$m<-max(as.integer(factor(dat$Sitecountry)))
datJags$study<-as.integer(factor(dat$Sitecountry))
datJags$state<-ifelse(dat$te_115==1,1,2)
datJags$y<-dat$gpr_56
datJags$studyTypeHospital<-dat$studyTypeHospital
datJags$testReasonL<-dat$testReasonL
datJags$alc<-dat$alc

randSeed<-20210615
set.seed(randSeed)

jagsModel4_te115_gpr56 <- jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
parsModel4_te115_gpr56<-coda.samples(model=jagsModel4_te115_gpr56,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)

tmp<-try(summary(parsModel4_te115_gpr56)$statistics,silent=TRUE)
tmpCI<-t(hdi(parsModel4_te115_gpr56))
mod_te115_gpr56<-cbind(tmp,tmpCI)
rm(tmp,tmpCI)
```

```{r model4NoBetweenStudyEffectsSimple_gpr56_te95, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
datJags<-list()

datJags$N<-nrow(dat)
datJags$m<-max(as.integer(factor(dat$Sitecountry)))
datJags$study<-as.integer(factor(dat$Sitecountry))
datJags$state<-ifelse(dat$te_95==1,1,2)
datJags$y<-dat$gpr_56
datJags$studyTypeHospital<-dat$studyTypeHospital
datJags$testReasonL<-dat$testReasonL
datJags$alc<-dat$alc

randSeed<-20210615
set.seed(randSeed)

jagsModel4_te95_gpr56 <- jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 10000) # needs to be large!
parsModel4_te95_gpr56<-coda.samples(model=jagsModel4_te95_gpr56,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)

tmp<-try(summary(parsModel4_te95_gpr56)$statistics,silent=TRUE)
tmpCI<-t(hdi(parsModel4_te95_gpr56))
mod_te95_gpr56<-cbind(tmp,tmpCI)
rm(tmp,tmpCI)
```

```{r model4NoBetweenStudyEffectsSimple_gpr32_te79, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
datJags<-list()

datJags$N<-nrow(dat)
datJags$m<-max(as.integer(factor(dat$Sitecountry)))
datJags$study<-as.integer(factor(dat$Sitecountry))
datJags$state<-ifelse(dat$te_79==1,1,2)
datJags$y<-dat$gpr_32
datJags$studyTypeHospital<-dat$studyTypeHospital
datJags$testReasonL<-dat$testReasonL
datJags$alc<-dat$alc

randSeed<-20210615
set.seed(randSeed)

jagsModel4_te79_gpr32 <- jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
parsModel4_te79_gpr32<-coda.samples(model=jagsModel4_te79_gpr32,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)

tmp<-try(summary(parsModel4_te79_gpr32)$statistics,silent=TRUE)
tmpCI<-t(hdi(parsModel4_te79_gpr32))
mod_te79_gpr32<-cbind(tmp,tmpCI)
rm(tmp,tmpCI)
```

```{r fixedThrSumApri, echo=FALSE}
save(c("jagsModel4_te115_apri20","jagsModel4_te95_apri20","jagsModel4_te79_apri15","jagsModel4_te115_gpr56","jagsModel4_te95_gpr56","jagsModel4_te79_gpr32","parsModel4_te115_apri20","parsModel4_te95_apri20","parsModel4_te79_apri15","parsModel4_te115_gpr56","parsModel4_te95_gpr56","parsModel4_te79_gpr32"),file=paste(sep="","fixedThresholdModelsResultsList_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))

sumFunTmp<-function(modSumTab){
  sens<-paste(sep="",format(nsmall=2,round(digits=2,100*modSumTab["sens","Mean"])),"%")
  sensCIlow<-paste(sep="",format(nsmall=2,round(digits=2,100*modSumTab["sens","lower"])),"%")
  sensCIupp<-paste(sep="",format(nsmall=2,round(digits=2,100*modSumTab["sens","upper"])),"%")
  sensCI<-paste(sep="","(",sensCIlow,",",sensCIupp,")")
  
  spec<-paste(sep="",format(nsmall=2,round(digits=2,100*modSumTab["spec","Mean"])),"%")
  specCIlow<-paste(sep="",format(nsmall=2,round(digits=2,100*modSumTab["spec","lower"])),"%")
  specCIupp<-paste(sep="",format(nsmall=2,round(digits=2,100*modSumTab["spec","upper"])),"%")
  specCI<-paste(sep="","(",specCIlow,",",specCIupp,")")
  
  return(c(sens,sensCI,spec,specCI))
}

fixedThrSumTabApri<-data.frame(
  apri20_te115=sumFunTmp(mod_te115_apri20),
  apri20_te95=sumFunTmp(mod_te95_apri20),
  apri15_te79=sumFunTmp(mod_te79_apri15)
)

fixedThrSumTabApri %>%
  knitr::kable(caption = "Summaries of the sensitivites and specificities for the 3 models for pre-defined thresholds on APRI.", col.names=c("te>11.5","te>9.5","te>7.9"),row.names = FALSE,align = "c") %>%
  add_header_above(c("APRI>=2.0"=1,"APRI>=2.0"=1,"APRI>=0.32"=1)) %>%
  pack_rows(group_label="sensitivity\n(95% CI)",1,2) %>%
  pack_rows(group_label="specificity\n(95% CI)",3,4) %>%
  kable_styling(full_width = FALSE)
```

```{r fixedThrSumGpr, echo=FALSE}
fixedThrSumTabGpr<-data.frame(
  gpr56_te115=sumFunTmp(mod_te115_gpr56),
  gpr56_te95=sumFunTmp(mod_te95_gpr56),
  gpr32_te79=sumFunTmp(mod_te79_gpr32)
)

fixedThrSumTabGpr %>%
  knitr::kable(caption = "Summaries of the sensitivites and specificities for the 3 models for pre-defined thresholds on GPR.", col.names=c("te>11.5","te>9.5","te>7.9"),row.names = FALSE,align = "c") %>%
  add_header_above(c("GPR>=0.56"=1,"GPR>=0.56"=1,"GP>=0.32"=1)) %>%
  pack_rows(group_label="sensitivity\n(95% CI)",1,2) %>%
  pack_rows(group_label="specificity\n(95% CI)",3,4) %>%
  kable_styling(full_width = FALSE)
```


## Optimum thresholds for APRI

### F4 - te > 11.5kPa

```{r apri115Vect, warning=F, message=F, error=FALSE, results='hide'}
apriVect<-unique(c(0,1.5,2,round(digits=2,quantile(dat$apri,probs=seq(0,1,length=40)))))
apriVect<-sort(apriVect) # length 43

apri115ResultsList<-list()
apri115ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(apriVect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  apr<-apriVect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_115==1,1,2)
  datJags$y<-ifelse(dat$apri>=apr,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(apriVect)){
  apr<-apriVect[i]
  
  apri115ModList[[paste(sep="","apri_mod_",apr)]]<-parList[[i]]$model
  apri115ModList[[paste(sep="","apri_samples_",apr)]]<-parList[[i]]$pars
  apri115ResultsList[[paste(sep="","apri",apr)]]<-parList[[i]]$results
}

rm(parList)
save(apri115ResultsList,apri115ModList,file=paste(sep="","apriResultsList_te115_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r apri115VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(apriVect))
specVect<-numeric(length(apriVect))
for(i in 1:length(apriVect)){
  sensVect[i]<-apri115ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-apri115ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  apri=apriVect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-apriVect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r apri115Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nAPRI threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for APRI with diagnosis threshold te > 11.5kPa (F4).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on APRI (from 0 to 13.26 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

apri115ResultsList[[paste(sep="","apri",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) APRI model for F4 (te > 11.5kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

### F4 - te > 9.5kPa

```{r apri95Vect, warning=F, message=F, error=FALSE, results='hide'}
apriVect<-unique(c(0,1.5,2,round(digits=2,quantile(dat$apri,probs=seq(0,1,length=40)))))
apriVect<-sort(apriVect) # length 43

apri95ResultsList<-list()
apri95ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(apriVect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  apr<-apriVect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_95==1,1,2)
  datJags$y<-ifelse(dat$apri>=apr,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(apriVect)){
  apr<-apriVect[i]
  
  apri95ModList[[paste(sep="","apri_mod_",apr)]]<-parList[[i]]$model
  apri95ModList[[paste(sep="","apri_samples_",apr)]]<-parList[[i]]$pars
  apri95ResultsList[[paste(sep="","apri",apr)]]<-parList[[i]]$results
}

rm(parList)
save(apri95ResultsList,apri95ModList,file=paste(sep="","apriResultsList_te95_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r apri95VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(apriVect))
specVect<-numeric(length(apriVect))
for(i in 1:length(apriVect)){
  sensVect[i]<-apri95ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-apri95ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  apri=apriVect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-apriVect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r apri95Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nAPRI threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for APRI with diagnosis threshold te > 9.5kPa (F4).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on APRI (from 0 to 13.26 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

apri95ResultsList[[paste(sep="","apri",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) APRI model for F4 (te > 9.5kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

### F2 - te > 7.9kPa

```{r apri79Vect, warning=F, message=F, error=FALSE, results='hide'}
apriVect<-unique(c(0,1.5,2,round(digits=2,quantile(dat$apri,probs=seq(0,1,length=40)))))
apriVect<-sort(apriVect) # length 43

apri79ResultsList<-list()
apri79ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(apriVect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  apr<-apriVect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_79==1,1,2)
  datJags$y<-ifelse(dat$apri>=apr,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(apriVect)){
  apr<-apriVect[i]
  
  apri79ModList[[paste(sep="","apri_mod_",apr)]]<-parList[[i]]$model
  apri79ModList[[paste(sep="","apri_samples_",apr)]]<-parList[[i]]$pars
  apri79ResultsList[[paste(sep="","apri",apr)]]<-parList[[i]]$results
}

rm(parList)
save(apri79ResultsList,apri79ModList,file=paste(sep="","apriResultsList_te79_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r apri79VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(apriVect))
specVect<-numeric(length(apriVect))
for(i in 1:length(apriVect)){
  sensVect[i]<-apri79ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-apri79ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  apri=apriVect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-apriVect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r apri79Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nAPRI threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for APRI with diagnosis threshold te > 7.9kPa (F2).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on APRI (from 0 to 13.26 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

apri79ResultsList[[paste(sep="","apri",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) APRI model for F2 (te > 7.9kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```


## Optimum thresholds for GPR

Note that the GPR data is the only one of APRI, GPR, ALT, FIB4 to have missing values. These are ignored when selecting the threshold points. The Bayesian models will integrate them out in a principled fashion.

### F4 - te > 11.5kPa

```{r gpr115Vect, warning=F, message=F, error=FALSE, results='hide'}
gprVect<-unique(round(digits=2,quantile(dat$gpr,probs=seq(0,1,length=54),na.rm=T)))
gprVect<-sort(c(0,gprVect,1,2,3,4,5,6,8,10)) # length 40

gpr115ResultsList<-list()
gpr115ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(gprVect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  gpr<-gprVect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_115==1,1,2)
  datJags$y<-ifelse(dat$gpr>=gpr,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(gprVect)){
  gpr<-gprVect[i]
  
  gpr115ModList[[paste(sep="","gpr_mod_",gpr)]]<-parList[[i]]$model
  gpr115ModList[[paste(sep="","gpr_samples_",gpr)]]<-parList[[i]]$pars
  gpr115ResultsList[[paste(sep="","gpr",gpr)]]<-parList[[i]]$results
}

rm(parList)
save(gpr115ResultsList,gpr115ModList,file=paste(sep="","gprResultsList_te115_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r gpr115VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(gprVect))
specVect<-numeric(length(gprVect))
for(i in 1:length(gprVect)){
  sensVect[i]<-gpr115ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-gpr115ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  gpr=gprVect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-gprVect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r gpr115Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nGPR threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for GPR with diagnosis threshold te > 11.5kPa (F4).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on GPR (from 0 to 13.65 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

gpr115ResultsList[[paste(sep="","gpr",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) GPR model for F4 (te > 11.5kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

### F4 - te > 9.5kPa

```{r gpr95Vect, warning=F, message=F, error=FALSE, results='hide'}
gprVect<-unique(round(digits=2,quantile(dat$gpr,probs=seq(0,1,length=54),na.rm=T)))
gprVect<-sort(c(0,gprVect,1,2,3,4,5,6,8,10)) # length 40

gpr95ResultsList<-list()
gpr95ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(gprVect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  gpr<-gprVect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_95==1,1,2)
  datJags$y<-ifelse(dat$gpr>=gpr,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(gprVect)){
  gpr<-gprVect[i]
  
  gpr95ModList[[paste(sep="","gpr_mod_",gpr)]]<-parList[[i]]$model
  gpr95ModList[[paste(sep="","gpr_samples_",gpr)]]<-parList[[i]]$pars
  gpr95ResultsList[[paste(sep="","gpr",gpr)]]<-parList[[i]]$results
}

rm(parList)
save(gpr95ResultsList,gpr95ModList,file=paste(sep="","gprResultsList_te95_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r gpr95VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(gprVect))
specVect<-numeric(length(gprVect))
for(i in 1:length(gprVect)){
  sensVect[i]<-gpr95ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-gpr95ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  gpr=gprVect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-gprVect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r gpr95Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nGPR threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for GPR with diagnosis threshold te > 9.5kPa (F4).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on GPR (from 0 to 13.65 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

gpr95ResultsList[[paste(sep="","gpr",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) GPR model for F4 (te > 9.5kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

### F2 - te > 7.9kPa

```{r gpr79Vect, warning=F, message=F, error=FALSE, results='hide'}
gprVect<-unique(round(digits=2,quantile(dat$gpr,probs=seq(0,1,length=54),na.rm=T)))
gprVect<-sort(c(0,gprVect,1,2,3,4,5,6,8,10)) # length 40

gpr79ResultsList<-list()
gpr79ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(gprVect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  gpr<-gprVect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_79==1,1,2)
  datJags$y<-ifelse(dat$gpr>=gpr,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(gprVect)){
  gpr<-gprVect[i]
  
  gpr79ModList[[paste(sep="","gpr_mod_",gpr)]]<-parList[[i]]$model
  gpr79ModList[[paste(sep="","gpr_samples_",gpr)]]<-parList[[i]]$pars
  gpr79ResultsList[[paste(sep="","gpr",gpr)]]<-parList[[i]]$results
}

rm(parList)
save(gpr79ResultsList,gpr79ModList,file=paste(sep="","gprResultsList_te79_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r gpr79VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(gprVect))
specVect<-numeric(length(gprVect))
for(i in 1:length(gprVect)){
  sensVect[i]<-gpr79ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-gpr79ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  gpr=gprVect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-gprVect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r gpr79Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nGPR threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for GPR with diagnosis threshold te > 7.9kPa (F2).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on GPR (from 0 to 13.65 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

gpr79ResultsList[[paste(sep="","gpr",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) GPR model for F2 (te > 7.9kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```


## Optimum thresholds for ALT

### F4 - te > 11.5kPa

```{r alt115Vect, warning=F, message=F, error=FALSE, results='hide'}
altVect<-unique(round(digits=0,quantile(dat$alt,probs=seq(0,1,length=52))))
altVect<-c(0,altVect) # length 40

alt115ResultsList<-list()
alt115ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(altVect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  alt<-altVect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_115==1,1,2)
  datJags$y<-ifelse(dat$alt>=alt,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(altVect)){
  alt<-altVect[i]
  
  alt115ModList[[paste(sep="","alt_mod_",alt)]]<-parList[[i]]$model
  alt115ModList[[paste(sep="","alt_samples_",alt)]]<-parList[[i]]$pars
  alt115ResultsList[[paste(sep="","alt",alt)]]<-parList[[i]]$results
}

rm(parList)
save(alt115ResultsList,alt115ModList,file=paste(sep="","altResultsList_te115_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r alt115VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(altVect))
specVect<-numeric(length(altVect))
for(i in 1:length(altVect)){
  sensVect[i]<-alt115ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-alt115ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  alt=altVect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-altVect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r alt115Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nALT threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for ALT with diagnosis threshold te > 11.5kPa (F4).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on ALT (from 1 to 198 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

alt115ResultsList[[paste(sep="","alt",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) ALT model  for F4 (te > 11.5kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

### F4 - te > 9.5kPa

```{r alt95Vect, warning=F, message=F, error=FALSE, results='hide'}
altVect<-unique(round(digits=0,quantile(dat$alt,probs=seq(0,1,length=52))))
altVect<-c(0,altVect) # length 40

alt95ResultsList<-list()
alt95ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(altVect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  alt<-altVect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_95==1,1,2)
  datJags$y<-ifelse(dat$alt>=alt,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(altVect)){
  alt<-altVect[i]
  
  alt95ModList[[paste(sep="","alt_mod_",alt)]]<-parList[[i]]$model
  alt95ModList[[paste(sep="","alt_samples_",alt)]]<-parList[[i]]$pars
  alt95ResultsList[[paste(sep="","alt",alt)]]<-parList[[i]]$results
}

rm(parList)
save(alt95ResultsList,alt95ModList,file=paste(sep="","altResultsList_te95_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r alt95VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(altVect))
specVect<-numeric(length(altVect))
for(i in 1:length(altVect)){
  sensVect[i]<-alt95ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-alt95ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  alt=altVect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-altVect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r alt95Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nALT threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for ALT with diagnosis threshold te > 9.5kPa (F4).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on ALT (from 1 to 198 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

alt95ResultsList[[paste(sep="","alt",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) ALT model  for F4 (te > 9.5kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

### F2 - te > 7.9kPa

```{r alt79Vect, warning=F, message=F, error=FALSE, results='hide'}
altVect<-unique(round(digits=0,quantile(dat$alt,probs=seq(0,1,length=52))))
altVect<-c(0,altVect) # length 40

alt79ResultsList<-list()
alt79ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(altVect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  alt<-altVect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_79==1,1,2)
  datJags$y<-ifelse(dat$alt>=alt,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(altVect)){
  alt<-altVect[i]
  
  alt79ModList[[paste(sep="","alt_mod_",alt)]]<-parList[[i]]$model
  alt79ModList[[paste(sep="","alt_samples_",alt)]]<-parList[[i]]$pars
  alt79ResultsList[[paste(sep="","alt",alt)]]<-parList[[i]]$results
}

rm(parList)
save(alt79ResultsList,alt79ModList,file=paste(sep="","altResultsList_te79_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r alt79VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(altVect))
specVect<-numeric(length(altVect))
for(i in 1:length(altVect)){
  sensVect[i]<-alt79ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-alt79ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  alt=altVect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-altVect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r alt79Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nALT threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for ALT with diagnosis threshold te > 7.9kPa (F2).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on ALT (from 1 to 198 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

alt79ResultsList[[paste(sep="","alt",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) ALT model  for F2 (te > 7.9kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

## Optimum thresholds for FIB4

### F4 - te > 11.5kPa

```{r fib4115Vect, warning=F, message=F, error=FALSE, results='hide'}
fib4Vect<-unique(round(digits=2,quantile(dat$fib4,probs=seq(0,1,length=40))))
fib4Vect<-sort(c(0,fib4Vect,6,10)) # length 43

fib4115ResultsList<-list()
fib4115ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(fib4Vect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  fib4<-fib4Vect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_115==1,1,2)
  datJags$y<-ifelse(dat$fib4>=fib4,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(fib4Vect)){
  fib4<-fib4Vect[i]
  
  fib4115ModList[[paste(sep="","fib4_mod_",fib4)]]<-parList[[i]]$model
  fib4115ModList[[paste(sep="","fib4_samples_",fib4)]]<-parList[[i]]$pars
  fib4115ResultsList[[paste(sep="","fib4",fib4)]]<-parList[[i]]$results
}

rm(parList)
save(fib4115ResultsList,fib4115ModList,file=paste(sep="","fib4ResultsList_te115_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r fib4115VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(fib4Vect))
specVect<-numeric(length(fib4Vect))
for(i in 1:length(fib4Vect)){
  sensVect[i]<-fib4115ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-fib4115ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  fib4=fib4Vect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-fib4Vect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r fib4115Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nFIB4 threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for FIB4 with diagnosis threshold te > 11.5kPa (F4).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on FIB4 (from 0 to 38.35 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

fib4115ResultsList[[paste(sep="","fib4",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) FIB4 model for F4 (te > 11.5kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

### F4 - te > 9.5kPa

```{r fib495Vect, warning=F, message=F, error=FALSE, results='hide'}
fib4Vect<-unique(round(digits=2,quantile(dat$fib4,probs=seq(0,1,length=40))))
fib4Vect<-sort(c(0,fib4Vect,6,10)) # length 43

fib495ResultsList<-list()
fib495ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(fib4Vect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  fib4<-fib4Vect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_95==1,1,2)
  datJags$y<-ifelse(dat$fib4>=fib4,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(fib4Vect)){
  fib4<-fib4Vect[i]
  
  fib495ModList[[paste(sep="","fib4_mod_",fib4)]]<-parList[[i]]$model
  fib495ModList[[paste(sep="","fib4_samples_",fib4)]]<-parList[[i]]$pars
  fib495ResultsList[[paste(sep="","fib4",fib4)]]<-parList[[i]]$results
}

rm(parList)
save(fib495ResultsList,fib495ModList,file=paste(sep="","fib4ResultsList_te95_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r fib495VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(fib4Vect))
specVect<-numeric(length(fib4Vect))
for(i in 1:length(fib4Vect)){
  sensVect[i]<-fib495ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-fib495ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  fib4=fib4Vect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-fib4Vect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r fib495Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nFIB4 threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for FIB4 with diagnosis threshold te > 9.5kPa (F4).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on FIB4 (from 0 to 38.35 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

fib495ResultsList[[paste(sep="","fib4",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) FIB4 model for F4 (te > 9.5kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

### F2 - te > 7.9kPa

```{r fib479Vect, warning=F, message=F, error=FALSE, results='hide'}
fib4Vect<-unique(round(digits=2,quantile(dat$fib4,probs=seq(0,1,length=40))))
fib4Vect<-sort(c(0,fib4Vect,6,10)) # length 43

fib479ResultsList<-list()
fib479ModList<-list()

cl <- parallel::makeCluster(6)
doParallel::registerDoParallel(cl)

parList<-foreach(i=1:length(fib4Vect),.packages=c("rjags","HDInterval","dplyr")) %dopar% {
  fib4<-fib4Vect[i]
  
  datJags<-list()
  
  datJags$N<-nrow(dat)
  datJags$m<-max(as.integer(factor(dat$Sitecountry)))
  datJags$study<-as.integer(factor(dat$Sitecountry))
  datJags$state<-ifelse(dat$te_79==1,1,2)
  datJags$y<-ifelse(dat$fib4>=fib4,1,0)
  datJags$studyTypeHospital<-dat$studyTypeHospital
  datJags$testReasonL<-dat$testReasonL
  datJags$alc<-dat$alc
  
  randSeed<-20210615
  set.seed(randSeed)
  
  jagsModel4 <- rjags::jags.model('jagsModel4_IndivAndStudyCovariatesNoBetweenStudyEffects_withAlc_simplerTestReason.jags', data=datJags, n.chains = 4, n.adapt = 2500)
  parsModel4 <- rjags::coda.samples(model=jagsModel4,variable.names=c('sens','spec','orGammaL','orGammaA','orLambda','reSens','reSpec'),n.iter = 6000)
  
  resultsModel4<-try(summary(parsModel4)$statistics,silent=TRUE)
  resultsModel4<-cbind(resultsModel4,t(hdi(parsModel4)))
  
  resultsModel4 <- resultsModel4 %>%
    as.data.frame() %>%
    mutate(
      Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
      upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
    mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
    dplyr::select(c(Mean,CrI))
  rownames(resultsModel4)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

  list(model=jagsModel4,pars=parsModel4,results=resultsModel4)
}

parallel::stopCluster(cl)

for(i in 1:length(fib4Vect)){
  fib4<-fib4Vect[i]
  
  fib479ModList[[paste(sep="","fib4_mod_",fib4)]]<-parList[[i]]$model
  fib479ModList[[paste(sep="","fib4_samples_",fib4)]]<-parList[[i]]$pars
  fib479ResultsList[[paste(sep="","fib4",fib4)]]<-parList[[i]]$results
}

rm(parList)
save(fib479ResultsList,fib479ModList,file=paste(sep="","fib4ResultsList_te79_",gsub(pattern="-",replacement="",Sys.Date()),".RData"))
```

```{r fib479VectSummary, warning=F, message=F, error=FALSE, results='hide'}
sensVect<-numeric(length(fib4Vect))
specVect<-numeric(length(fib4Vect))
for(i in 1:length(fib4Vect)){
  sensVect[i]<-fib479ResultsList[[i]]["overall sensitivity","Mean"]
  specVect[i]<-fib479ResultsList[[i]]["overall specificity","Mean"]
}
youdenJ<-sensVect+specVect-1

aucSensVect<-c(1,sensVect,0)
aucOnemSpecVect<-c(1,1-specVect,0)
idxOrder<-order(decreasing = FALSE,aucOnemSpecVect)
aucOnemSpecVect<-aucOnemSpecVect[idxOrder]
aucSensVect<-aucSensVect[idxOrder]

aucX<-aucOnemSpecVect[-1]-aucOnemSpecVect[-length(aucOnemSpecVect)]
aucY<-(aucSensVect[-length(aucSensVect)]+aucSensVect[-1])/2
auc<-sum(aucX*aucY)

dfROC<-data.frame(
  fib4=fib4Vect,
  sensitivity=sensVect,
  specificity=specVect,
  YoudenJ=youdenJ
)

idxBestYouden<-which(youdenJ==max(youdenJ))
bestThr<-fib4Vect[idxBestYouden]
bestSens<-sensVect[idxBestYouden]
bestSpec<-specVect[idxBestYouden]
```

```{r fib479Plot, fig.width=10, fig.height=10}
dfROC %>%
  ggplot(mapping=aes(x=1-specificity,y=sensitivity)) +
  geom_smooth(col="orange",fill="orange",method="scam",formula = y ~ s(x, k = 5, bs = "mpi")) +
  geom_point(alpha=1,col="darkgrey") +
  geom_line(alpha=0.65,lwd=0.3,col="darkgrey") +
  geom_vline(xintercept=1-bestSpec,lty=2,col="grey") +
  geom_hline(yintercept=bestSens,lty=2,col="grey") +
  geom_text(x=1-bestSpec,y=bestSens,label=paste(sep="","Optimum Youden J = ",format(nsmall=2,round(digits=2,max(youdenJ))),"\nFIB4 threshold = ",bestThr)) +
  labs(title=paste(sep="","ROC curve for FIB4 with diagnosis threshold te > 7.9kPa (F2).\nAUC = ",format(nsmall=2,round(digits=2,auc))),caption="Bayesian bivariate random-effects models fitted for different threshold on FIB4 (from 0 to 38.35 according to 40 equally spaced quantiles).\nGiven the Bayesian nature of the data, there is some variability due to MCMC sampling.\nThe ROC curve (orange) is a shape-constrained generalized additive model fitted to the raw estimates (grey).\nAUC is computed from the raw estimates.") +
  theme_light()

fib479ResultsList[[paste(sep="","fib4",bestThr)]] %>%
  kable(caption="Best (according to Youden's J) FIB4 model for F2 (te > 7.9kPa) with site/study specific sensitivities and specificities (random effects).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```


## Appendix - models for fixed thresholds on APRI and GPR

```{r model4_apri20_te115Summary}
tmp<-mod_te115_apri20 %>%
  as.data.frame() %>%
  mutate(
    Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
    upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
  mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
  dplyr::select(c(Mean,CrI))
rownames(tmp)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

tmp %>%
  kable(caption="Bivariate random effects model for APRI$\\geq2.0$ and te>11.5 (F4).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

```{r model4_apri20_te95Summary}
tmp<-mod_te95_apri20 %>%
  as.data.frame() %>%
  mutate(
    Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
    upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
  mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
  dplyr::select(c(Mean,CrI))
rownames(tmp)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

tmp %>%
  kable(caption="Bivariate random effects model for APRI$\\geq2.0$ and te>9.5 (F4).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

```{r model4_apri15_te79Summary}
tmp<-mod_te79_apri15 %>%
  as.data.frame() %>%
  mutate(
    Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
    upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
  mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
  dplyr::select(c(Mean,CrI))
rownames(tmp)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

tmp %>%
  kable(caption="Bivariate random effects model for APRI$\\geq1.5$ and te>7.9 (F2).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

```{r model4_gpr56_te115Summary}
tmp<-mod_te115_gpr56 %>%
  as.data.frame() %>%
  mutate(
    Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
    upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
  mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
  dplyr::select(c(Mean,CrI))
rownames(tmp)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

tmp %>%
  kable(caption="Bivariate random effects model for GPR$\\geq0.56$ and te>11.5 (F4).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

```{r model4_gpr56_te95Summary}
tmp<-mod_te95_gpr56 %>%
  as.data.frame() %>%
  mutate(
    Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
    upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
  mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
  dplyr::select(c(Mean,CrI))
rownames(tmp)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

tmp %>%
  kable(caption="Bivariate random effects model for GPR$\\geq0.56$ and te>9.5 (F4).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

```{r model4_gpr32_te79Summary}
tmp<-mod_te79_gpr32 %>%
  as.data.frame() %>%
  mutate(
    Mean=case_when(Mean>1e100~Inf,TRUE~Mean),
    upper=case_when(upper>1e100~Inf,TRUE~upper)) %>%
  mutate(CrI=paste(sep="","(",format(nsmall=4,round(digits=4,lower)),",",format(nsmall=4,round(digits=4,upper)),")")) %>%
  dplyr::select(c(Mean,CrI))
rownames(tmp)<-c("hazardous alcohol drinking (OR for sensitivity)","hazardous alcohol drinking (OR for specificity)","suspected liver disease screening (OR for sensitivity)","suspected liver disease screening (OR for specificity)","hospital-based study (OR for sensitivity)","hospital-based study (OR for specificity)","random effects variance (logit sensitivity)","random effects variance (logit specificity)","overall sensitivity","overall specificity")

tmp %>%
  kable(caption="Bivariate random effects model for GPR$\\geq0.32$ and te>7.9 (F2).",digits=4,col.names=c("Posterior mean","95% HDI credible interval"),align=c("r","r")) %>%
  kable_styling(full_width = FALSE)
```

